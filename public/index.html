<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Party Jukebox</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;color:#fff;-webkit-font-smoothing:antialiased}
    .container{max-width:600px;margin:0 auto;padding:16px;padding-bottom:80px}
    header{text-align:center;padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:16px}
    h1{font-size:1.75rem;margin-bottom:4px}
    h1 span{color:#1DB954}
    .subtitle{color:rgba(255,255,255,0.6);font-size:0.85rem}
    .status-bar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;background:rgba(255,255,255,0.05);padding:10px 12px;border-radius:8px;margin-bottom:16px}
    .status-indicator{display:flex;align-items:center;gap:8px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#ff4444;flex-shrink:0}
    .status-dot.connected{background:#1DB954}
    .btn{background:#1DB954;color:#fff;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:0.85rem;text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:background 0.2s}
    .btn:hover{background:#1ed760}
    .btn-secondary{background:rgba(255,255,255,0.1)}
    .btn-secondary:hover{background:rgba(255,255,255,0.2)}
    .btn:disabled{background:rgba(255,255,255,0.2);cursor:not-allowed}
    .track-limit{background:rgba(255,255,255,0.05);padding:8px 12px;border-radius:6px;margin-bottom:16px;font-size:0.85rem;display:flex;justify-content:space-between;align-items:center}
    .track-limit-bar{width:100px;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden}
    .track-limit-fill{height:100%;background:#1DB954;transition:width 0.3s}
    .now-playing{background:rgba(29,185,84,0.1);border:1px solid rgba(29,185,84,0.3);border-radius:12px;padding:12px;margin-bottom:16px;display:none}
    .now-playing.visible{display:flex;align-items:center;gap:12px}
    .now-playing-art{width:56px;height:56px;border-radius:8px;object-fit:cover;flex-shrink:0}
    .now-playing-info{flex:1;min-width:0}
    .now-playing-info h3{font-size:0.75rem;color:rgba(255,255,255,0.6);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
    .now-playing-info .track-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .now-playing-info .artist-name{color:rgba(255,255,255,0.7);font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .search-section{margin-bottom:16px}
    .search-box{display:flex;gap:8px}
    .search-input{flex:1;padding:14px 16px;border-radius:25px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-size:1rem;outline:none;min-width:0}
    .search-input::placeholder{color:rgba(255,255,255,0.5)}
    .search-input:focus{background:rgba(255,255,255,0.15)}
    .search-btn{padding:14px 20px;border-radius:25px;border:none;background:#1DB954;color:#fff;font-size:1rem;cursor:pointer;white-space:nowrap}
    .search-btn:hover{background:#1ed760}
    .search-btn:disabled{background:rgba(255,255,255,0.2);cursor:not-allowed}
    .tabs{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .tab{padding:8px 16px;border-radius:20px;background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.7);cursor:pointer;white-space:nowrap;border:none;font-size:0.85rem}
    .tab.active{background:#1DB954;color:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .results,.queue-list{display:flex;flex-direction:column;gap:8px}
    .track-card{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.05);padding:10px;border-radius:10px;transition:background 0.2s}
    .track-card:hover{background:rgba(255,255,255,0.1)}
    .track-art{width:48px;height:48px;border-radius:4px;object-fit:cover;flex-shrink:0}
    .track-info{flex:1;min-width:0}
    .track-name{font-weight:600;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track-artist{color:rgba(255,255,255,0.7);font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track-album{color:rgba(255,255,255,0.5);font-size:0.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track-actions{display:flex;gap:6px;align-items:center;flex-shrink:0}
    .add-btn{background:#1DB954;color:#fff;border:none;padding:8px 14px;border-radius:16px;cursor:pointer;font-weight:600;font-size:0.8rem;transition:all 0.2s}
    .add-btn:hover{background:#1ed760}
    .add-btn:disabled{background:rgba(255,255,255,0.2);cursor:not-allowed}
    .add-btn.added{background:rgba(29,185,84,0.3)}
    .vote-btn{background:rgba(255,255,255,0.1);color:#fff;border:none;padding:6px 10px;border-radius:12px;cursor:pointer;font-size:0.8rem;display:flex;align-items:center;gap:4px;transition:all 0.2s}
    .vote-btn:hover{background:rgba(255,255,255,0.2)}
    .vote-btn.voted{background:rgba(29,185,84,0.3);color:#1DB954}
    .message{text-align:center;padding:32px 16px;color:rgba(255,255,255,0.6)}
    .error-message{background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);color:#ff6b6b;padding:12px;border-radius:8px;margin-bottom:16px;text-align:center;font-size:0.9rem}
    .success-toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1DB954;color:#fff;padding:12px 20px;border-radius:25px;font-weight:600;opacity:0;transition:opacity 0.3s;z-index:1000;font-size:0.9rem}
    .success-toast.visible{opacity:1}
    .host-section{text-align:center;padding:40px 16px}
    .host-section h2{margin-bottom:8px}
    .host-section p{color:rgba(255,255,255,0.6);margin-bottom:24px}
    .config-warning{background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);color:#ffc107;padding:16px;border-radius:8px;text-align:left;font-size:0.9rem}
    .config-warning h3{margin-bottom:8px}
    .config-warning code{background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px}
    .config-warning ol{margin-left:20px;margin-top:8px}
    .qr-section{text-align:center;padding:16px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:16px}
    .qr-section h3{margin-bottom:12px;font-size:0.9rem;color:rgba(255,255,255,0.8)}
    .qr-code{max-width:200px;margin:0 auto 12px}
    .qr-code img{width:100%;height:auto;border-radius:8px}
    .qr-url{font-size:0.8rem;color:rgba(255,255,255,0.6);word-break:break-all}
    .admin-panel{background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;margin-bottom:16px}
    .admin-panel h3{margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .admin-controls{display:flex;flex-wrap:wrap;gap:8px}
    .admin-login{display:flex;gap:8px}
    .admin-input{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-size:0.9rem}
    @media(max-width:480px){
      .search-box{flex-direction:column}
      .search-btn{width:100%}
      .track-card{flex-wrap:wrap}
      .track-actions{width:100%;justify-content:flex-end;margin-top:8px}
      .admin-login{flex-direction:column}
      .tabs{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéµ Party <span>Jukebox</span></h1>
      <p class="subtitle">Search and add songs to the queue</p>
    </header>

    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Checking...</span>
      </div>
      <div id="authActions"></div>
    </div>

    <div id="errorMessage" class="error-message" style="display:none;"></div>

    <div id="configWarning" class="config-warning" style="display:none;">
      <h3>‚ö†Ô∏è Configuration Required</h3>
      <p>Spotify credentials are not configured. The host needs to:</p>
      <ol>
        <li>Create a Spotify app at <a href="https://developer.spotify.com/dashboard" target="_blank" rel="noopener" style="color:#1DB954;">developer.spotify.com</a></li>
        <li>Set environment variables: <code>SPOTIFY_CLIENT_ID</code> and <code>SPOTIFY_CLIENT_SECRET</code></li>
        <li>Restart the server</li>
      </ol>
    </div>

    <div id="hostSection" class="host-section" style="display:none;">
      <h2>Welcome, Host!</h2>
      <p>Connect your Spotify account to let guests add songs to your queue.</p>
      <a href="/login" class="btn">Connect Spotify</a>
    </div>

    <div id="mainContent" style="display:none;">
      <div id="trackLimitBar" class="track-limit">
        <span>Tracks remaining: <strong id="tracksRemaining">5</strong>/<span id="tracksMax">5</span></span>
        <div class="track-limit-bar">
          <div class="track-limit-fill" id="trackLimitFill" style="width:100%"></div>
        </div>
      </div>

      <div id="nowPlaying" class="now-playing">
        <img id="nowPlayingArt" class="now-playing-art" src="" alt="">
        <div class="now-playing-info">
          <h3>NOW PLAYING</h3>
          <div id="nowPlayingTrack" class="track-name"></div>
          <div id="nowPlayingArtist" class="artist-name"></div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="search">üîç Search</button>
        <button class="tab" data-tab="queue">üìã Queue</button>
        <button class="tab" data-tab="qr">üì± Share</button>
        <button class="tab" data-tab="admin">‚öôÔ∏è Admin</button>
      </div>

      <div id="searchTab" class="tab-content active">
        <div class="search-section">
          <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="Search for a song..." autocomplete="off">
            <button id="searchBtn" class="search-btn">Search</button>
          </div>
        </div>
        <div id="results" class="results">
          <div class="message">Search for songs to add to the queue</div>
        </div>
      </div>

      <div id="queueTab" class="tab-content">
        <div id="queueList" class="queue-list">
          <div class="message">No songs in the party queue yet. Add some!</div>
        </div>
      </div>

      <div id="qrTab" class="tab-content">
        <div class="qr-section">
          <h3>üì± Scan to Join the Party!</h3>
          <div class="qr-code" id="qrCode">
            <div class="message">Loading QR code...</div>
          </div>
          <div class="qr-url" id="qrUrl"></div>
        </div>
      </div>

      <div id="adminTab" class="tab-content">
        <div class="admin-panel">
          <h3>üîê Host Controls</h3>
          <div id="adminLoginForm">
            <p style="color:rgba(255,255,255,0.6);margin-bottom:12px;font-size:0.85rem;">Enter the admin password to access host controls.</p>
            <div class="admin-login">
              <input type="password" id="adminPassword" class="admin-input" placeholder="Admin password">
              <button id="adminLoginBtn" class="btn">Login</button>
            </div>
          </div>
          <div id="adminControls" style="display:none;">
            <p style="color:rgba(255,255,255,0.6);margin-bottom:12px;font-size:0.85rem;">Logged in as admin</p>
            <div class="admin-controls">
              <button class="btn" onclick="adminSkip()">‚è≠Ô∏è Skip</button>
              <button class="btn" onclick="adminPause()">‚è∏Ô∏è Pause</button>
              <button class="btn" onclick="adminPlay()">‚ñ∂Ô∏è Play</button>
              <button class="btn btn-secondary" onclick="adminClearQueue()">üóëÔ∏è Clear Queue</button>
              <button class="btn btn-secondary" onclick="adminResetLimits()">üîÑ Reset Limits</button>
              <button class="btn btn-secondary" onclick="adminLogout()">Logout</button>
            </div>
          </div>
          <div id="adminNotConfigured" style="display:none;">
            <p style="color:rgba(255,255,255,0.6);font-size:0.85rem;">Admin panel not configured. Set <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">ADMIN_PASSWORD</code> environment variable.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="success-toast">Added to queue!</div>
  </div>

  <script>
    // State
    let adminToken = sessionStorage.getItem('adminToken') || '';
    let trackLimit = { used: 0, remaining: 5, max: 5 };

    // Elements
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const authActions = document.getElementById('authActions');
    const errorMessage = document.getElementById('errorMessage');
    const configWarning = document.getElementById('configWarning');
    const hostSection = document.getElementById('hostSection');
    const mainContent = document.getElementById('mainContent');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const results = document.getElementById('results');
    const nowPlaying = document.getElementById('nowPlaying');
    const nowPlayingArt = document.getElementById('nowPlayingArt');
    const nowPlayingTrack = document.getElementById('nowPlayingTrack');
    const nowPlayingArtist = document.getElementById('nowPlayingArtist');
    const toast = document.getElementById('toast');
    const queueList = document.getElementById('queueList');
    const tracksRemaining = document.getElementById('tracksRemaining');
    const tracksMax = document.getElementById('tracksMax');
    const trackLimitFill = document.getElementById('trackLimitFill');

    // Check for URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('error')) {
      showError('Authentication failed: ' + urlParams.get('error'));
      window.history.replaceState({}, document.title, '/');
    }
    if (urlParams.has('authenticated')) {
      window.history.replaceState({}, document.title, '/');
    }

    // Tab handling
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
        
        if (tab.dataset.tab === 'queue') loadPartyQueue();
        if (tab.dataset.tab === 'qr') loadQRCode();
        if (tab.dataset.tab === 'admin') checkAdminStatus();
      });
    });

    // Initialize
    checkStatus();

    // Event listeners
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });
    document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);
    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') adminLogin();
    });

    async function checkStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();

        if (!data.configured) {
          configWarning.style.display = 'block';
          statusDot.classList.remove('connected');
          statusText.textContent = 'Not configured';
          return;
        }

        if (data.authenticated) {
          statusDot.classList.add('connected');
          statusText.textContent = 'Connected';
          authActions.innerHTML = '<button class="btn btn-secondary" onclick="logout()">Disconnect</button>';
          mainContent.style.display = 'block';
          hostSection.style.display = 'none';
          updateNowPlaying();
          updateTrackLimit();
          setInterval(updateNowPlaying, 10000);
          setInterval(updateTrackLimit, 30000);
        } else {
          statusDot.classList.remove('connected');
          statusText.textContent = 'Not connected';
          authActions.innerHTML = '<a href="/login" class="btn">Connect</a>';
          hostSection.style.display = 'block';
          mainContent.style.display = 'none';
        }
      } catch (err) {
        showError('Failed to check status');
      }
    }

    async function updateTrackLimit() {
      try {
        const response = await fetch('/api/track-limit');
        const data = await response.json();
        trackLimit = data;
        tracksRemaining.textContent = data.remaining;
        tracksMax.textContent = data.max;
        trackLimitFill.style.width = ((data.remaining / data.max) * 100) + '%';
      } catch (err) {
        console.error('Failed to get track limit:', err);
      }
    }

    async function performSearch() {
      const query = searchInput.value.trim();
      if (!query) return;

      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';
      results.innerHTML = '<div class="message">Searching...</div>';

      try {
        const response = await fetch('/api/search?q=' + encodeURIComponent(query));
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Search failed');

        if (data.tracks.length === 0) {
          results.innerHTML = '<div class="message">No tracks found</div>';
          return;
        }

        // Store track data for safe access
        window.trackData = {};
        data.tracks.forEach(track => {
          window.trackData[track.id] = track;
        });

        results.innerHTML = data.tracks.map(track => {
          return `
          <div class="track-card">
            <img class="track-art" src="${track.albumArt || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2240%22>‚ô™</text></svg>'}" alt="${escapeHtml(track.album)}" loading="lazy">
            <div class="track-info">
              <div class="track-name">${escapeHtml(track.name)}</div>
              <div class="track-artist">${escapeHtml(track.artist)}</div>
              <div class="track-album">${escapeHtml(track.album)}</div>
            </div>
            <button class="add-btn" data-track-id="${escapeHtml(track.id)}" ${trackLimit.remaining <= 0 ? 'disabled' : ''}>Add</button>
          </div>
        `}).join('');

        // Add event listeners safely
        results.querySelectorAll('.add-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const trackId = this.dataset.trackId;
            const track = window.trackData[trackId];
            if (track) {
              addToQueue(track.uri, track.name, track.artist, track.albumArt, this);
            }
          });
        });
      } catch (err) {
        results.innerHTML = '<div class="message">' + escapeHtml(err.message) + '</div>';
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Search';
      }
    }

    async function addToQueue(uri, name, artist, albumArt, button) {
      button.disabled = true;
      button.textContent = 'Adding...';

      try {
        const response = await fetch('/api/queue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uri, name, artist, albumArt })
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to add to queue');

        button.textContent = 'Added ‚úì';
        button.classList.add('added');
        showToast('Added to queue!');
        
        if (data.remaining !== undefined) {
          trackLimit.remaining = data.remaining;
          tracksRemaining.textContent = data.remaining;
          trackLimitFill.style.width = ((data.remaining / trackLimit.max) * 100) + '%';
        }
      } catch (err) {
        button.textContent = 'Add';
        button.disabled = false;
        showError(err.message);
      }
    }

    async function loadPartyQueue() {
      try {
        const response = await fetch('/api/party-queue');
        const data = await response.json();

        if (data.queue.length === 0) {
          queueList.innerHTML = '<div class="message">No songs in the party queue yet. Add some!</div>';
          return;
        }

        queueList.innerHTML = data.queue.map(track => `
          <div class="track-card">
            <img class="track-art" src="${track.albumArt || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2240%22>‚ô™</text></svg>'}" alt="" loading="lazy">
            <div class="track-info">
              <div class="track-name">${escapeHtml(track.name)}</div>
              <div class="track-artist">${escapeHtml(track.artist)}</div>
            </div>
            <div class="track-actions">
              <button class="vote-btn ${track.hasVoted ? 'voted' : ''}" onclick="voteTrack('${track.id}', this)">
                üëç <span>${track.votes}</span>
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        queueList.innerHTML = '<div class="message">Failed to load queue</div>';
      }
    }

    async function voteTrack(trackId, button) {
      try {
        const response = await fetch('/api/vote/' + trackId, { method: 'POST' });
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Vote failed');

        button.classList.toggle('voted', data.hasVoted);
        button.querySelector('span').textContent = data.votes;
      } catch (err) {
        showError(err.message);
      }
    }

    async function loadQRCode() {
      const qrCode = document.getElementById('qrCode');
      const qrUrl = document.getElementById('qrUrl');
      
      try {
        const response = await fetch('/api/qrcode');
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to generate QR code');

        qrCode.innerHTML = '<img src="' + data.qrcode + '" alt="QR Code">';
        qrUrl.textContent = data.url;
      } catch (err) {
        qrCode.innerHTML = '<div class="message">Failed to generate QR code</div>';
      }
    }

    async function checkAdminStatus() {
      try {
        const response = await fetch('/api/admin/status');
        const data = await response.json();

        if (!data.configured) {
          document.getElementById('adminLoginForm').style.display = 'none';
          document.getElementById('adminControls').style.display = 'none';
          document.getElementById('adminNotConfigured').style.display = 'block';
          return;
        }

        document.getElementById('adminNotConfigured').style.display = 'none';
        
        if (adminToken) {
          document.getElementById('adminLoginForm').style.display = 'none';
          document.getElementById('adminControls').style.display = 'block';
        } else {
          document.getElementById('adminLoginForm').style.display = 'block';
          document.getElementById('adminControls').style.display = 'none';
        }
      } catch (err) {
        showError('Failed to check admin status');
      }
    }

    async function adminLogin() {
      const password = document.getElementById('adminPassword').value;
      if (!password) return;

      try {
        const response = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Login failed');

        adminToken = data.token;
        sessionStorage.setItem('adminToken', adminToken);
        document.getElementById('adminPassword').value = '';
        checkAdminStatus();
        showToast('Admin login successful!');
      } catch (err) {
        showError(err.message);
      }
    }

    function adminLogout() {
      adminToken = '';
      sessionStorage.removeItem('adminToken');
      checkAdminStatus();
    }

    async function adminAction(endpoint, method = 'POST') {
      try {
        const response = await fetch(endpoint, {
          method,
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + adminToken
          }
        });

        const data = await response.json();

        if (response.status === 401 || response.status === 403) {
          adminLogout();
          throw new Error('Session expired. Please login again.');
        }

        if (!response.ok) throw new Error(data.error || 'Action failed');

        return data;
      } catch (err) {
        showError(err.message);
        throw err;
      }
    }

    async function adminSkip() {
      await adminAction('/api/admin/skip');
      showToast('Track skipped!');
      updateNowPlaying();
    }

    async function adminPause() {
      await adminAction('/api/admin/pause');
      showToast('Playback paused');
    }

    async function adminPlay() {
      await adminAction('/api/admin/play');
      showToast('Playback resumed');
    }

    async function adminClearQueue() {
      if (!confirm('Clear all songs from the party queue?')) return;
      await adminAction('/api/admin/queue', 'DELETE');
      showToast('Queue cleared');
      loadPartyQueue();
    }

    async function adminResetLimits() {
      if (!confirm('Reset track limits for all users?')) return;
      await adminAction('/api/admin/reset-limits');
      showToast('Track limits reset');
      updateTrackLimit();
    }

    async function updateNowPlaying() {
      try {
        const response = await fetch('/api/playback');
        const data = await response.json();

        if (data.track) {
          nowPlaying.classList.add('visible');
          nowPlayingArt.src = data.track.albumArt || '';
          nowPlayingTrack.textContent = data.track.name;
          nowPlayingArtist.textContent = data.track.artist;
        } else {
          nowPlaying.classList.remove('visible');
        }
      } catch (err) {}
    }

    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.reload();
      } catch (err) {
        showError('Failed to logout');
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => errorMessage.style.display = 'none', 5000);
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2000);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
