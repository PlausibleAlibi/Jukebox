<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Analytics - Brooklyn's JukeBox</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:linear-gradient(135deg,#0a0a0a 0%,#1a1a1a 50%,#2a2520 100%);min-height:100vh;color:#fff;-webkit-font-smoothing:antialiased}
    .container{max-width:1200px;margin:0 auto;padding:16px;padding-bottom:80px}
    header{text-align:center;padding:16px 0;border-bottom:1px solid rgba(255,215,0,0.2);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
    .header-title{flex:1;text-align:center}
    h1{font-size:1.75rem;margin-bottom:4px}
    h1 span{color:#FFD700}
    .subtitle{color:rgba(255,255,255,0.6);font-size:0.85rem}
    .btn{background:#FFD700;color:#000;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:0.85rem;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:background 0.2s}
    .btn:hover{background:#FFC700}
    .btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
    .btn-secondary:hover{background:rgba(255,255,255,0.2)}
    .btn:disabled{background:rgba(255,255,255,0.2);cursor:not-allowed;color:rgba(255,255,255,0.5)}
    .back-link{text-decoration:none}
    .controls-bar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;margin-bottom:16px}
    .controls-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .controls-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .last-updated{color:rgba(255,255,255,0.6);font-size:0.75rem}
    .filter-select{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,215,0,0.3);padding:6px 12px;border-radius:16px;cursor:pointer;font-size:0.85rem;outline:none}
    .filter-select:focus{border-color:#FFD700}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:24px}
    .stat-card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,215,0,0.2);border-radius:12px;padding:16px;text-align:center}
    .stat-value{font-size:2rem;font-weight:bold;color:#FFD700;margin-bottom:4px}
    .stat-label{font-size:0.85rem;color:rgba(255,255,255,0.7)}
    .stat-sublabel{font-size:0.75rem;color:rgba(255,255,255,0.5);margin-top:4px}
    .chart-section{background:rgba(255,255,255,0.05);border:1px solid rgba(255,215,0,0.2);border-radius:12px;padding:20px;margin-bottom:24px}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px}
    .chart-title{font-size:1.25rem;font-weight:600;display:flex;align-items:center;gap:8px}
    .chart-container{position:relative;height:300px}
    .leaderboard{list-style:none}
    .leaderboard-item{display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:8px;transition:background 0.2s}
    .leaderboard-item:hover{background:rgba(255,255,255,0.1)}
    .leaderboard-rank{font-size:1.25rem;font-weight:bold;color:#FFD700;width:40px;text-align:center}
    .leaderboard-info{flex:1;margin:0 12px}
    .leaderboard-name{font-weight:600;font-size:0.95rem}
    .leaderboard-nickname{color:rgba(255,255,255,0.5);font-size:0.75rem}
    .leaderboard-value{font-size:1rem;font-weight:600;color:#FFD700}
    .track-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:8px;transition:background 0.2s}
    .track-item:hover{background:rgba(255,255,255,0.1)}
    .track-art{width:48px;height:48px;border-radius:4px;object-fit:cover;flex-shrink:0}
    .track-info{flex:1;min-width:0}
    .track-name{font-weight:600;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track-artist{color:rgba(255,255,255,0.7);font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track-count{font-size:1rem;font-weight:600;color:#FFD700;display:flex;align-items:center;gap:4px}
    .loading{text-align:center;padding:40px;color:rgba(255,255,255,0.6)}
    .loading-spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(255,215,0,0.2);border-top-color:#FFD700;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error-message{background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);color:#ff6b6b;padding:16px;border-radius:8px;margin-bottom:16px;text-align:center}
    .empty-state{text-align:center;padding:40px;color:rgba(255,255,255,0.5)}
    .footer{text-align:center;padding:32px 16px 16px 16px;color:rgba(255,255,255,0.4);font-size:0.8rem;border-top:1px solid rgba(255,215,0,0.1);margin-top:32px}
    .checkbox-container{display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none}
    .checkbox-container input[type="checkbox"]{cursor:pointer;width:16px;height:16px}
    @media(max-width:768px){
      .controls-bar{flex-direction:column;align-items:stretch}
      .controls-left,.controls-right{justify-content:space-between;width:100%}
      .stats-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
      .chart-container{height:250px}
      .leaderboard-rank{width:30px;font-size:1rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/" class="back-link btn btn-secondary">‚Üê Back</a>
      <div class="header-title">
        <h1>üìä Analytics <span>Dashboard</span></h1>
        <p class="subtitle">Party music trends and insights</p>
      </div>
      <div style="width:80px"></div>
    </header>

    <div id="errorMessage" class="error-message" style="display:none;"></div>

    <div class="controls-bar">
      <div class="controls-left">
        <button id="refreshBtn" class="btn">üîÑ Refresh</button>
        <label class="checkbox-container">
          <input type="checkbox" id="autoRefreshToggle">
          <span>Auto-refresh (30s)</span>
        </label>
      </div>
      <div class="controls-right">
        <select id="limitFilter" class="filter-select">
          <option value="5">Top 5</option>
          <option value="10" selected>Top 10</option>
          <option value="20">Top 20</option>
        </select>
        <button id="exportBtn" class="btn btn-secondary">üì• Export JSON</button>
        <span class="last-updated">Last updated: <span id="lastUpdated">Never</span></span>
      </div>
    </div>

    <!-- General Statistics -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </div>

    <!-- Top Tracks Chart -->
    <div class="chart-section">
      <div class="chart-header">
        <h2 class="chart-title">üéµ Top Requested Tracks</h2>
      </div>
      <div id="topTracksContainer">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </div>

    <!-- Top Users Leaderboard -->
    <div class="chart-section">
      <div class="chart-header">
        <h2 class="chart-title">üë• Most Active Users</h2>
      </div>
      <div id="topUsersContainer">
        <div class="loading"><div class="loading-spinner"></div></div>
      </div>
    </div>

    <!-- Peak Hours Chart -->
    <div class="chart-section">
      <div class="chart-header">
        <h2 class="chart-title">üìà Peak Usage Hours</h2>
      </div>
      <div class="chart-container" id="peakHoursContainer">
        <canvas id="peakHoursChart"></canvas>
      </div>
    </div>

    <div class="footer">
      ‚ú® powered by Tucker ‚ú®
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // State
    let autoRefreshInterval = null;
    let currentLimit = parseInt(localStorage.getItem('analyticsLimit')) || 10;
    let autoRefreshEnabled = localStorage.getItem('autoRefresh') === 'true';
    let allData = {
      stats: null,
      topTracks: null,
      topUsers: null,
      peakHours: null
    };
    let charts = {
      peakHours: null
    };

    // Elements
    const refreshBtn = document.getElementById('refreshBtn');
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    const limitFilter = document.getElementById('limitFilter');
    const exportBtn = document.getElementById('exportBtn');
    const lastUpdated = document.getElementById('lastUpdated');
    const errorMessage = document.getElementById('errorMessage');
    const statsGrid = document.getElementById('statsGrid');
    const topTracksContainer = document.getElementById('topTracksContainer');
    const topUsersContainer = document.getElementById('topUsersContainer');
    const peakHoursChart = document.getElementById('peakHoursChart');

    // Initialize
    limitFilter.value = currentLimit;
    autoRefreshToggle.checked = autoRefreshEnabled;
    loadAllData();

    // Setup auto-refresh if enabled
    if (autoRefreshEnabled) {
      startAutoRefresh();
    }

    // Event listeners
    refreshBtn.addEventListener('click', () => {
      loadAllData();
    });

    autoRefreshToggle.addEventListener('change', (e) => {
      autoRefreshEnabled = e.target.checked;
      localStorage.setItem('autoRefresh', autoRefreshEnabled);
      if (autoRefreshEnabled) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });

    limitFilter.addEventListener('change', (e) => {
      currentLimit = parseInt(e.target.value);
      localStorage.setItem('analyticsLimit', currentLimit);
      loadAllData();
    });

    exportBtn.addEventListener('click', () => {
      exportData();
    });

    function startAutoRefresh() {
      stopAutoRefresh();
      autoRefreshInterval = setInterval(loadAllData, 30000);
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    async function loadAllData() {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = 'üîÑ Refreshing...';
      
      try {
        await Promise.all([
          loadStats(),
          loadTopTracks(),
          loadTopUsers(),
          loadPeakHours()
        ]);
        
        updateLastUpdated();
        hideError();
      } catch (err) {
        showError('Failed to load analytics data: ' + err.message);
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = 'üîÑ Refresh';
      }
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/analytics/stats');
        if (!response.ok) throw new Error('Failed to fetch stats');
        
        const data = await response.json();
        allData.stats = data;
        renderStats(data);
      } catch (err) {
        console.error('Failed to load stats:', err);
        statsGrid.innerHTML = '<div class="error-message">Failed to load statistics</div>';
      }
    }

    async function loadTopTracks() {
      try {
        const response = await fetch(`/api/analytics/top-tracks?limit=${currentLimit}`);
        if (!response.ok) throw new Error('Failed to fetch top tracks');
        
        const data = await response.json();
        allData.topTracks = data;
        renderTopTracks(data.tracks);
      } catch (err) {
        console.error('Failed to load top tracks:', err);
        topTracksContainer.innerHTML = '<div class="error-message">Failed to load top tracks</div>';
      }
    }

    async function loadTopUsers() {
      try {
        const response = await fetch(`/api/analytics/top-users?limit=${currentLimit}`);
        if (!response.ok) throw new Error('Failed to fetch top users');
        
        const data = await response.json();
        allData.topUsers = data;
        renderTopUsers(data.users);
      } catch (err) {
        console.error('Failed to load top users:', err);
        topUsersContainer.innerHTML = '<div class="error-message">Failed to load top users</div>';
      }
    }

    async function loadPeakHours() {
      try {
        const response = await fetch('/api/analytics/peak-hours');
        if (!response.ok) throw new Error('Failed to fetch peak hours');
        
        const data = await response.json();
        allData.peakHours = data;
        renderPeakHours(data.hourlyStats);
      } catch (err) {
        console.error('Failed to load peak hours:', err);
        document.getElementById('peakHoursContainer').innerHTML = '<div class="error-message">Failed to load peak hours</div>';
      }
    }

    function renderStats(data) {
      const formatNumber = (num) => num.toLocaleString();
      
      const mostVotedTrack = data.mostVotedTrack 
        ? `${escapeHtml(data.mostVotedTrack.name)} (${data.mostVotedTrack.votes} votes)`
        : 'None yet';
      
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${formatNumber(data.totalTracksInQueue || 0)}</div>
          <div class="stat-label">Total Tracks</div>
          <div class="stat-sublabel">In Queue</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${formatNumber(data.totalUsers || 0)}</div>
          <div class="stat-label">Active Users</div>
          <div class="stat-sublabel">Contributors</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${formatNumber(data.totalVotes || 0)}</div>
          <div class="stat-label">Total Votes</div>
          <div class="stat-sublabel">Cast</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${formatNumber(data.totalTracksPlayed || 0)}</div>
          <div class="stat-label">Tracks Played</div>
          <div class="stat-sublabel">Completed</div>
        </div>
        <div class="stat-card" style="grid-column:1/-1">
          <div class="stat-label">üèÜ Most Voted Track</div>
          <div class="stat-sublabel" style="margin-top:8px">${mostVotedTrack}</div>
        </div>
      `;
    }

    function renderTopTracks(tracks) {
      if (!tracks || tracks.length === 0) {
        topTracksContainer.innerHTML = '<div class="empty-state">No tracks requested yet</div>';
        return;
      }

      const maxCount = tracks[0]?.requestCount || 1;
      
      topTracksContainer.innerHTML = tracks.map((track, index) => {
        const percentage = (track.requestCount / maxCount * 100).toFixed(0);
        return `
          <div class="track-item">
            <div class="leaderboard-rank">#${index + 1}</div>
            <img class="track-art" src="${track.albumArt || FALLBACK_ALBUM_ART}" alt="${escapeHtml(track.name)}" loading="lazy">
            <div class="track-info">
              <div class="track-name">${escapeHtml(track.name)}</div>
              <div class="track-artist">${escapeHtml(track.artist)}</div>
            </div>
            <div class="track-count">
              ${track.requestCount} <span style="font-size:0.75rem;color:rgba(255,255,255,0.5)">requests</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTopUsers(users) {
      if (!users || users.length === 0) {
        topUsersContainer.innerHTML = '<div class="empty-state">No users have added tracks yet</div>';
        return;
      }

      topUsersContainer.innerHTML = `
        <ul class="leaderboard">
          ${users.map((user, index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
            const displayName = user.nickname || user.ipAddress;
            const subLabel = user.nickname ? `IP: ${user.ipAddress}` : 'No nickname';
            
            return `
              <li class="leaderboard-item">
                <div class="leaderboard-rank">${medal}</div>
                <div class="leaderboard-info">
                  <div class="leaderboard-name">${escapeHtml(displayName)}</div>
                  <div class="leaderboard-nickname">${escapeHtml(subLabel)}</div>
                </div>
                <div class="leaderboard-value">${user.trackCount} tracks</div>
              </li>
            `;
          }).join('')}
        </ul>
      `;
    }

    // Constants
    const FALLBACK_ALBUM_ART = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2240%22>‚ô™</text></svg>';

    // Shared utility function for hour formatting
    function formatHour(hour) {
      const displayHour = hour % 12 || 12;
      const ampm = hour < 12 ? 'AM' : 'PM';
      return `${displayHour}${ampm}`;
    }

    function renderPeakHours(hourlyStats) {
      if (!hourlyStats || hourlyStats.length === 0) {
        document.getElementById('peakHoursContainer').innerHTML = '<div class="empty-state">No usage data available yet</div>';
        return;
      }

      // Check if Chart.js is available
      if (typeof Chart === 'undefined') {
        // Fallback to simple HTML bar chart
        renderPeakHoursSimple(hourlyStats);
        return;
      }

      // Create 24-hour array with counts
      const hourCounts = new Array(24).fill(0);
      hourlyStats.forEach(stat => {
        if (stat.hour >= 0 && stat.hour < 24) {
          hourCounts[stat.hour] = stat.trackCount || stat.count;
        }
      });

      const labels = Array.from({length: 24}, (_, i) => formatHour(i));

      // Destroy existing chart if it exists
      if (charts.peakHours) {
        charts.peakHours.destroy();
      }

      // Create new chart
      const ctx = peakHoursChart.getContext('2d');
      charts.peakHours = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Tracks Added',
            data: hourCounts,
            backgroundColor: 'rgba(255, 215, 0, 0.6)',
            borderColor: 'rgba(255, 215, 0, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(26, 26, 46, 0.9)',
              titleColor: '#FFD700',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 215, 0, 0.3)',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `${context.parsed.y} tracks added`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)',
                stepSize: 1
              },
              grid: {
                color: 'rgba(255, 215, 0, 0.1)'
              }
            },
            x: {
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderPeakHoursSimple(hourlyStats) {
      // Fallback simple bar chart when Chart.js is not available
      const hourCounts = new Array(24).fill(0);
      hourlyStats.forEach(stat => {
        if (stat.hour >= 0 && stat.hour < 24) {
          hourCounts[stat.hour] = stat.trackCount || stat.count;
        }
      });

      const maxCount = Math.max(...hourCounts, 1);
      
      const container = document.getElementById('peakHoursContainer');
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); gap: 8px; padding: 20px;">
          ${hourCounts.map((count, hour) => {
            const height = (count / maxCount * 200);
            const hourLabel = formatHour(hour);
            return `
              <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                <div style="font-size: 0.7rem; color: rgba(255, 215, 0, 0.8);">${count}</div>
                <div style="width: 100%; height: 200px; display: flex; align-items: flex-end; justify-content: center;">
                  <div style="width: 80%; height: ${height}px; background: rgba(255, 215, 0, 0.6); border-radius: 4px 4px 0 0; min-height: ${count > 0 ? '4px' : '0'};"></div>
                </div>
                <div style="font-size: 0.65rem; color: rgba(255, 255, 255, 0.5); transform: rotate(-45deg); width: 30px;">${hourLabel}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function updateLastUpdated() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      lastUpdated.textContent = timeStr;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    function exportData() {
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      const exportData = {
        timestamp: new Date().toISOString(),
        stats: allData.stats,
        topTracks: allData.topTracks,
        topUsers: allData.topUsers,
        peakHours: allData.peakHours
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `jukebox-analytics-${timestamp}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopAutoRefresh();
      if (charts.peakHours) {
        charts.peakHours.destroy();
      }
    });
  </script>
</body>
</html>
